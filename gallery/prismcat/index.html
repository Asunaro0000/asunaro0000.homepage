<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PrismCat Memory | Asunaro Works</title>

  <!-- このページは /gallery/prismcat/ 配下なので、サイト共通CSSは ../../ で参照 -->
  <link rel="stylesheet" href="../../css/style.css"/>
  <script src="https://unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
  <header class="nav">
    <a class="brand" href="../../">Asunaro Works</a>
    <nav>
      <a href="../../gallery/">Gallery</a>
      <a href="../../about/">About</a>
      <a href="../../process/">Process</a>
      <a href="../../contact/">Contact</a>
    </nav>
  </header>

  <main>
    <section id="series-hero" class="section"></section>
    <section id="phases" class="cards"></section>
  </main>

  <footer>© 2025 Asunaro Works. All rights reserved.</footer>

  <script type="module">
    import { loadYAML } from '../../js/util/yaml-loader.js';

    /** 現在ページの深さから、プロジェクト直下を基準に相対URLを作る */
    function relToRoot(p){
      if (!p) return p;
      p = String(p).replace(/^\/+/, ''); // 先頭スラッシュ剥がし（/assets/... も受ける）
      const path = location.pathname.replace(/index\.html$/,'');
      const depth = Math.max(path.split('/').filter(Boolean).length - 1, 0);
      return (depth ? '../'.repeat(depth) : './') + p;
    }

    /** この作品フォルダ（/gallery/prismcat/）からの相対に直す */
    function relToWork(p){
      if (!p) return p;
      p = String(p).replace(/^\/+/, '');
      // 作品のassetsが gallery/prismcat/assets にある前提なので、
      // assets/ で始まる場合は './assets/...' にマップする
      if (p.startsWith('assets/')) return './' + p;
      // それ以外（gallery/prismcat/phase-x/ など）はそのまま相対で使う場合もある
      return p;
    }

    (async ()=>{
      // YAML は data/series/prismcat.yaml（プロジェクト直下）
      const data = await loadYAML('../../data/series/prismcat.yaml');
      const s = data.series;

      // カバー（YAMLが assets/... or /assets/... でもOK）
      const cover = s.cover || (s.phases?.[0]?.hero ?? '');
      const heroImg = relToWork(cover) || relToRoot(cover); // まず作品内assets優先、無ければプロジェクト直下

      const hero = document.getElementById('series-hero');
      hero.innerHTML = `
        <div class="figure">
          <img src="${heroImg}" alt="${s.title}">
        </div>
        <h1>${s.title}</h1>
        <p class="muted">${s.description || ''}</p>
      `;

      // フェーズ一覧
      const phases = document.getElementById('phases');
      phases.innerHTML = (s.phases || []).map(p => {
        const raw = p.hero || p.background || '';
        const thumb = relToWork(raw) || relToRoot(raw);
        // 各フェーズのページは gallery/prismcat/<phase-id>/ （共通CSSはそこからさらに ../../ が必要）
        const link  = `./${p.id}/`;
        return `
          <a class="card" href="${link}">
            ${thumb ? `<img src="${thumb}" alt="${p.title}" loading="lazy">` : ''}
            <div class="body">
              <h3>${p.title}</h3>
              <p>${p.caption || ''}</p>
            </div>
          </a>
        `;
      }).join('');
    })();
  </script>
</body>
</html>
